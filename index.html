<!DOCTYPE html>
<html lang="en" class="document">
  <head>
    <meta charset="utf-8"/>
    <style>
      @font-face {
        font-display: swap;
        font-family: 'PT Mono';
        font-style: normal;
        font-weight: 400;
        src:
          local('PT Mono'),
          local('PTMono-Regular'),
          url('/fonts/pt-mono-v7-latin-regular.woff2') format('woff2'),
          url('/fonts/pt-mono-v7-latin-regular.woff') format('woff');
      }

      * {
        box-sizing: border-box;
        font: inherit;
        margin: 0;
        padding: 0;
        max-width: 100%;
      }

      .document {
        height: 100%;
      }

      .body {
        justify-content: center;
        font-family: 'PT Mono', monospace;
        font-size: 24px;
        line-height: 1.5;
        color: #222;
        display: flex;
        height: 100%;
      }

      .calculator {
        display: grid;
        margin: auto;
        width: 20em;
        padding: 1em;
        gap: 0.25em;
        grid-template-columns: repeat(4, 1fr);
        grid-template-areas:
          'output  output   output  output'
          'clear   plus     minus   times'
          'seven   eight    nine    divide'
          'four    five     six     equals'
          'one     two      three   equals'
          'zero    decimal  sign    equals';

        --hue: 200;
        --saturation: 5%;
      }

      .calculator-element {
        border-radius: 3px;
        border: 3px solid var(--background);
        grid-area: var(--grid-area);

        --background: hsl(var(--hue), var(--saturation), 50%);
      }

      .calculator-output {
        display: flex;
        padding: 1em;
        grid-area: output;
        justify-content: flex-end;
        line-height: 1;
        height: 3em;
        color: var(--background);
      }

      .calculator-button {
        background: var(--background);
        color: white;
        min-height: 3em;
      }

      .button-operator,
      .button-clear {
        --saturation: 60%;
      }

      .button-clear {
        --hue: 350;
      }

    </style>
  </head>
  <body class="body">
    <form></form>
    <script type="module" crossorigin="anonymous">
    import framework, {domUpdate, view, raw} from '@erickmerchant/framework'

    const target = document.querySelector('form')

    const update = domUpdate(target)

    const {app, btn} = view()

    const button = (commit, onclick, area, txt) => {
      let className = 'calculator-button calculator-element'

      if (['plus', 'minus', 'times', 'divide', 'equals'].includes(area)) {
        className += ' button-operator'
      }

      if (area === 'clear') {
        className += ' button-clear'
      }

      return btn`<button
        type="button"
        class=${className}
        style=${`--grid-area: ${area}`}
        onclick=${() => {
          commit(onclick)
        }}>${txt}</button>`
    }

    const clear = () => {
      return {
        output: null,
        left: null,
        operator: null,
        right: null,
        done: false
      }
    }

    const state = clear()

    const equals = (state) => {
      if (state.left == null || state.operator == null || state.right == null) {
        return state
      }

      state.output = 'left'

      const left = Number(state.left)
      const right = Number(state.right)

      switch (state.operator) {
        case '+':
          state.left = left + right
          break

        case '-':
          state.left = left - right
          break

        case '*':
          state.left = left * right
          break

        case '/':
          state.left = left / right
          break
      }

      state.done = true

      return state
    }

    const operator = (operator) => (state) => {
      if (state.left == null) {
        return state
      }

      if (state.output === 'right') {
        equals(state)
      }

      state.right = null

      state.operator = operator

      state.done = false

      return state
    }

    const character = (character) => (state) => {
      if (state.done) {
        state = clear()
      }

      let target = 'right'

      if (state.operator == null) {
        target = 'left'
      }

      if (state[target] == null) {
        state[target] = character === '.' ? '0.' : character
      } else if (character !== '.' || !state[target].includes('.')) {
        state[target] += character
      }

      state.output = target

      return state
    }

    const sign = (state) => {
      const target = state.output

      if (state[target] != null) {
        const number = Number(state[target])

        state[target] = number * -1
      }

      return state
    }

    const format = (val) => {
      if (typeof val === 'number') return val

      const index = val.indexOf('.')
      const number = Number(val)

      if (index < 0) {
        return number
      }

      const digits = val.length - index - 1

      if (digits) {
        return number.toFixed(digits)
      }

      return number.toFixed(1)
    }

    framework({
      state,
      update,
      component({state, commit}) {
        return app`<form class="calculator">
          <output class="calculator-output calculator-element">${state.output ? format(state[state.output]) : '0'}</output>
          ${button(commit, clear, 'clear', 'AC')}
          ${button(commit, operator('+'), 'plus', raw('&plus;'))}
          ${button(commit, operator('-'), 'minus', raw('&minus;'))}
          ${button(commit, operator('*'), 'times', raw('&times;'))}
          ${button(commit, operator('/'), 'divide', raw('&divide;'))}
          ${button(commit, equals, 'equals', raw('&equals;'))}
          ${button(commit, character('0'), 'zero', 0)}
          ${button(commit, character('1'), 'one', 1)}
          ${button(commit, character('2'), 'two', 2)}
          ${button(commit, character('3'), 'three', 3)}
          ${button(commit, character('4'), 'four', 4)}
          ${button(commit, character('5'), 'five', 5)}
          ${button(commit, character('6'), 'six', 6)}
          ${button(commit, character('7'), 'seven', 7)}
          ${button(commit, character('8'), 'eight', 8)}
          ${button(commit, character('9'), 'nine', 9)}
          ${button(commit, character('.'), 'decimal', '.')}
          ${button(commit, sign, 'sign', raw('&plusmn;'))}
        </form>`
      }
    })
    </script>
  </body>
</html>
